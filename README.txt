This collection of scripts supports the extraction of FRET efficiency, Donor (Donor excitation), Donor (Acceptor excitation), Acceptor (Donor excitation) and Acceptor (Acceptor excitation) traces for single molecules from tiff-stack data corresponding to alternating frames of donor and acceptor excitation windows (ALternating Laser Exitation, ALEX). This is done utilizing modified existing MatLab codes written in the Rothenberg Lab as well as additional Python codes for calculation of FRET correction parameters. 

These functionalities are available via other ALEX or MFD-focused FRET analysis software suites, and these scripts are provided as-is during migration of our in-lab written code base to Python for extensibility and addition of additional functionalities. Other software suites that include these scripts' current functionalities or similar include several tools listed by the FRET Community (https://fret.community/software/). These include MASH-FRET, DEEP-FRET, iSMS, DeepLASI, and FRETBOARD, amongst others.


Requirements:
MatLab scripts were written for MatLab 2018b and all required supporting codes are included in the MatLabTraceExtractions zip. Simply unzip the folder and add the resulting directory to MatLab Path so the channels_map and mainBatch scripts can access the relevant dependencies. These scripts can be run as previously described (need citation if available from RLab FRET papers).

Python:
Python scripts were written for and testing in Python 3.9.13
Package dependencies are the latest versions of:
numpy 1.23.5
pandas 1.5.3
matplotlib 3.8.4
fnmatch 0.5.2
scikit-learn 1.2.2
scikit-image 0.18.1
scipy 1.10.1
tifffile 23.2.28

Installation:
Python packages available through pip or Anaconda package managers.
Scripts require no other installation, although in this version are intended to be run cell-by cell in an Interactive Python IDE supporting the #%% cell delimiter.
Installation of packages depends on package manager but typically will take <10 minutes.

Data and outputs:
Tiff stack data corresponding to multi-frame ALEX movies are the expected raw data for the MatLab mapping and trace extraction scripts. Alternating frames should be ordered donor-acceptor-donor... and alternating frames should be contained in the same stack dimension (TXY dimensions). Output from trace extraction scripts should be .mat files containing MatLab data sctructures containing the relevant frame-by-frame trace data. These are the expected inputs for the Python correction parameter calculation pipeline. 

To calculate ALEX correction parameters to convert traces to fully-corrected FRET efficiency (convert to distances via the well-known E=(1+(r/R0)^6)^(-1) equation) and fluorescence stoichiometry traces. The outputs are the correction parameters alpha, beta, gamma, and delta detailed in https://www.nature.com/articles/s41592-018-0085-0. Finally, the .mat traces along with the known correction parameters can be used as inputs to ApplyAlexCorr_toSelected.py to obtain output .mat files containing fully-corrected FRET efficiency trace data for kinetics analysis, histogramming, etc.

Instructions:
Required data: 
Mapping image - single frame vertically split green/red bead image with both channels illuminated simultaneously
Standards FRET data: Donor only, acceptor-only, and FRET standard samples measured in ALEX mode with vertically spli donor/acceptor images (donor/green on left, acceptor/red on right). Here, we use lab standards corresponding to "low," "medium," and "high" FRET efficiencies, or 20, 15, and 10 bp of dsDNA between fluorophores incorporated into the DNA backbone.


MatLab:
As previously described, we generate and apply parameters for mapping of distinct color channels to one another using a polywarp operation in MatLab. Our lab utilizes a single emccd camera with emission from the two color channels sent to each half of the camera chip (split vertically). The included MatLab script "channels_map_2chHalfChip_rgb_emccd.m" can be run from the MatLab editor and will accept a single-frame tiff image with bright beads in both color channels as input. Beads in each color channel are overlaid and then the user selects 9 pairs of matching beads. The script then uses these selections to fit polywarp parameters to overlay all beads in the green image against the reference channel (RED) beads. Next, "mainBatch_FRET_ALEX_wholeim_alltraces_test_splitimsel.m" expects a directory of images (structured as "data/<samplename>/<tiff images>") each named spool.tif, spool_1.tif, spool_2.tif... alongside the .map file generated by the mapping script. The resulting ".mat" files will be parsed by the Python scripts which expect the name of the directory containing these .mat files.
"DataWrapper_ebFRET_modified_matfiles_forFRET.m" should be run at this point to obtain plaintext FRET trace files used for ebFRET and similar kinetic analysis software suites.

Python:
Following MatLab based trace extraction, Python scripts are to be run in the following order:
"Calculate_ALEX_alpha_delta.py" corresponding to the alpha and delta correction parameters on which beta and gamma depend (directory containing trace files from MatLab loaded as input). Output is a text file in an indicated corrections folder containing alpha and delta values as well as alpha/delta-corrected E vs. S 2d histogram images.
"Calculate_ALEX_beta_gamma_4_24_Nsamps.py" corresponding to the beta and gamma correction parameter calculations (alpha and delta file in output directory from previous step, as well as .mat trace files as input). Will generate output text file containing beta and gamma values in corrections folder, as well as corrected FRET efficiency v Stoichiometry histogram images.
"ApplyAlexCorr_toSelected.py" corresponding to application of correction parameters to obtain the fully corrected FRET and Stoichiometry traces. Input data is .dat files converted to ebFRET-compatible text format using DataWrapper_ebFRET script in MatLab at an earlier step. Output files are in the same format but contain gamma-corrected donor, alpha and delta corrected acceptor, and fully corrected FRET efficiency values for use in ebFRET or similar analysis suites.

Runtime on test machine equipped with 11th Gen Intel(R) Core(TM) i7-1185G7 @ 3.00GHz 1.80 GHz was ~10 minutes. 

Demo data available at:
https://zenodo.org/records/13830702

Outline of demo:
For compatibility reasons (although an issue with misordered images was fixed), after raw data is collected and organized into the data structure as in the demo datase (data/image_folder/spool.tif), the data must first be run through "Save_Reordered_OG_image_4_1.py". To do so, simply replace the folderpath and folders strings with the location of the demo data folder to be processed. 
Ex: folderpath = r'C:\Users\GH\Desktop\FromD\SUDIPTA_ALEX_Correction\demo_data'
    folders = [r'DO\\donor_only']
Do so for all folders (this has been done for demo data, so can be skipped). This will result in tiffs with '_sorted.tif' appended to their names.
Next, in MatLab 2018b, run "mainBatch_FRET_ALEX_wholeim_alltraces_test_splitimsel.m", pointing it to the provided mapping files when prompted. For data folder, select the folder containing image folders. Ex: for DA_samples, select demo_data\DA_samples and it willl process all subfolders. DA samples should be processed with map_method = 'FRET'. For our setup, DO should be processed via 'Left' mode and AO via 'Right'. This is assumed in later Python scripts. This step has been performed for demo data. This will result in .mat files containing trace data.
Next, run 'Calculate_ALEX_alpha_delta.py'. Change the DOfolder, AOfolder, and Corrections_Folder strings to the correct locations (ex: for DO, r'...demo_data\DO\donor_only'). Change the DOimages and AOimages values to the number of files for each to use in analysis (2 with demo files). Optionally, enable smoothing by setting it to True and choose an odd-value smoothing window (not enabled for demo). This will generate several images of uncorrected and alpha+delta corrected DO/AO 2D histograms, as well as a text file containing the alpha and delta values. Plots can be adjusted by adjusting the parameters at the plt.hexbin lines. 
Next, run 'Calculate_ALEX_beta_gamma_4_24_Nsamps.py' similarly to obtain beta, gamma. It will automatically load the file generated to contain alpha and delta parameters. Analysis can be performed with >=2 folders of DA data, contained as strings in the list DAfolders. This demo includes 3 folders of samples consisting of dsDNA with dyes at differing numbers of nucleotides from each other incorporated into the DNA backbone (Cy3, Cy5 pair). The number of images to use from each folder is included in the list DAimages. The parameter subsample_to_reweight can be set to True to allow counts for each sample to be reweighted such that each folder is weighted equally in the fits to obtain beta and gamma. Set to False to disable. Again, smoothing can be enabled or disabled, and is disabled here. Outputs here are similar images of uncorrected, delta++alpha corrected, and alpha+beta+gamma+delta corrected SvE 2D histograms of standards. Additionally, a text file with beta and gamma parameters is generated. 
From here, the current workflow is to load the experimental traces of interest into vbFRET for dynamic trace selection and analysis. For plotting and applying correction parameters to selected traces, an outline script ('ApplyAlexCorr_toSelected.py') is provided which is applicable in our vbFRET workflow (and also optionally applies smoothing). The expected inputs are time, donor, acceptor, FRET_E formatted text files used in eb/vbFRET.

